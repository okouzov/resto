<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ресто</title>

  <!-- PWA -->
  <meta name="theme-color" content="#2563eb" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Ресто" />
  <link rel="manifest" href="manifest.webmanifest?v=20251231010818" />
  <link rel="icon" href="icon-192.png" sizes="192x192" />
  <link rel="apple-touch-icon" href="icon-192.png" />

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 8px 24px rgba(17,24,39,.08);
      --blue:#2563eb;
      --blueSoft:#e8f0ff;
      --danger:#b91c1c;
      --ok:#065f46;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width: 520px;
      margin: 0 auto;
      padding: 14px 12px 18px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:14px;
    }
    h1{
      font-size:16px;
      margin:0 0 10px;
      letter-spacing:.2px;
    }

    /* Segmented toggle */
    .seg{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:6px;
      padding:6px;
      border:1px solid var(--border);
      background:#f3f4f6;
      border-radius:14px;
      margin: 10px 0 12px;
    }
    .seg button{
      appearance:none;
      border:0;
      background:transparent;
      padding:10px 10px;
      border-radius:12px;
      font-weight:650;
      font-size:13px;
      color:var(--muted);
      cursor:pointer;
      transition: background .15s ease, color .15s ease, transform .05s ease;
    }
    .seg button:active{transform:scale(.99)}
    .seg button.active{
      background:var(--blueSoft);
      color:var(--blue);
      box-shadow: inset 0 0 0 1px rgba(37,99,235,.20);
    }

    .section{
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#fff;
      margin-bottom:10px;
    }
    .label{
      font-size:12px;
      color:var(--muted);
      margin:0 0 8px;
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    /* На мобилен: двойките полета да НЕ се чупят на нов ред */
    .row.nowrap{
      flex-wrap:nowrap;
      gap:8px;
    }

    .field{
      display:flex;
      align-items:center;
      gap:6px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      min-height:42px;
      flex:1;
      min-width:0; /* позволява свиване вместо пренасяне */
    }
    .field input{
      width:100%;
      min-width:0;
      border:0;
      outline:none;
      font-size:16px;
      background:transparent;
      color:var(--text);
      padding:0;
    }
    .field input.small{width:100%}
    .unit{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      flex:0 0 auto;
    }

    @media (max-width: 360px){
      .row.nowrap{gap:6px}
      .field{padding:7px 8px}
      .unit{font-size:11px}
    }

    .actions{
      display:flex;
      gap:10px;
      margin-top:12px;
    }
    .btn{
      width:100%;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      border-radius:14px;
      padding:12px 12px;
      font-weight:700;
      font-size:14px;
      cursor:pointer;
      transition: transform .05s ease, box-shadow .15s ease, border-color .15s ease;
    }
    .btn:active{transform:scale(.99)}
    .btn.primary{
      border-color: rgba(37,99,235,.35);
      box-shadow: 0 6px 16px rgba(37,99,235,.12);
    }

    .result{
      margin-top:12px;
      padding:12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#f9fafb;
    }
    .result .big{
      font-size:20px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .result .sub{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    .hint{
      margin-top:10px;
      font-size:11px;
      color:var(--muted);
      line-height:1.35;
    }
    .warn{color:var(--danger); font-weight:650}
    .ok{color:var(--ok); font-weight:650}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Калкулатор за ресто (в евро, в скоби – лева)</h1>

      <div class="seg" role="tablist" aria-label="Дължима сума">
        <button id="tabEur" class="active" type="button" role="tab" aria-selected="true">Дължимо в EUR</button>
        <button id="tabBgn" type="button" role="tab" aria-selected="false">Дължимо в BGN</button>
      </div>

      <div class="section" id="dueSection">
        <div class="label" id="dueLabel">Дължима сума (EUR)</div>
        <div class="row nowrap">
          <div class="field" id="dueMajorWrap">
            <input id="dueMajor" inputmode="numeric" pattern="[0-9]*" placeholder="0" aria-label="Дължима сума - основна" />
            <span class="unit" id="dueMajorUnit">€</span>
          </div>
          <div class="field" id="dueMinorWrap">
            <input id="dueMinor" class="small" inputmode="numeric" pattern="[0-9]*" placeholder="00" aria-label="Дължима сума - стотинки" />
            <span class="unit" id="dueMinorUnit">ц</span>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="label">Дадени пари (BGN)</div>
        <div class="row nowrap">
          <div class="field">
            <input id="paidLev" inputmode="numeric" pattern="[0-9]*" placeholder="0" aria-label="Дадени лева" />
            <span class="unit">лв</span>
          </div>
          <div class="field">
            <input id="paidSt" class="small" inputmode="numeric" pattern="[0-9]*" placeholder="00" aria-label="Дадени стотинки" />
            <span class="unit">ст</span>
          </div>
        </div>
      </div>

      <div class="actions">
        <button class="btn primary" id="calcBtn" type="button">Сметни</button>
        <button class="btn" id="clearBtn" type="button">Изчисти</button>
      </div>

      <div class="result" id="resultBox" aria-live="polite">
        <div class="big" id="resultMain">—</div>
        <div class="sub" id="resultSub">Въведи сума и натисни „Сметни“.</div>
      </div>

      <div class="hint">
        <div>Курс: <strong>1 EUR = 1.95583 BGN</strong>. Празно поле се счита за <strong>0</strong>. Резултатите се закръглят до 2 знака.</div>
        <div style="margin-top:6px">Build: <span id="buildTag">20251231010818</span></div>
      </div>
    </div>
  </div>

  <script>
    const RATE = 1.95583;

    const tabEur = document.getElementById('tabEur');
    const tabBgn = document.getElementById('tabBgn');
    const dueLabel = document.getElementById('dueLabel');
    const dueMajorUnit = document.getElementById('dueMajorUnit');
    const dueMinorUnit = document.getElementById('dueMinorUnit');

    const dueMajor = document.getElementById('dueMajor');
    const dueMinor = document.getElementById('dueMinor');
    const paidLev  = document.getElementById('paidLev');
    const paidSt   = document.getElementById('paidSt');

    const resultMain = document.getElementById('resultMain');
    const resultSub  = document.getElementById('resultSub');

    let dueMode = 'EUR'; // 'EUR' or 'BGN'

    function numOrZero(v){
      v = (v ?? '').toString().trim();
      if(v === '') return 0;
      const cleaned = v.replace(/[^0-9]/g,'');
      return cleaned === '' ? 0 : parseInt(cleaned, 10);
    }

    function clampMinor(minor){
      minor = Math.abs(minor|0);
      if(minor > 99) minor = minor % 100;
      return minor;
    }

    function toStotinki(lev, st){
      return (Math.abs(lev|0) * 100) + clampMinor(st);
    }

    function euroCentsToLevaSt(eurCents){
      const eur = eurCents / 100;
      const leva = eur * RATE;
      return Math.round(leva * 100);
    }

    function levaStToEuroCents(levaSt){
      const leva = levaSt / 100;
      const eur = leva / RATE;
      return Math.round(eur * 100);
    }

    function fmtEURfromCents(eurCents){
      const sign = eurCents < 0 ? '-' : '';
      eurCents = Math.abs(eurCents);
      const eur = Math.floor(eurCents / 100);
      const c = (eurCents % 100).toString().padStart(2,'0');
      return `${sign}${eur},${c} €`;
    }

    function fmtBGNfromSt(st){
      const sign = st < 0 ? '-' : '';
      st = Math.abs(st);
      const lev = Math.floor(st / 100);
      const s = (st % 100).toString().padStart(2,'0');
      return `${sign}${lev},${s} лв`;
    }

    function computeChange({dueMode, dueMajor, dueMinor, paidLev, paidSt}){
      const paidStot = toStotinki(paidLev, paidSt);

      let dueStot;
      if(dueMode === 'EUR'){
        const dueEurCents = (Math.abs(dueMajor|0) * 100) + clampMinor(dueMinor);
        dueStot = euroCentsToLevaSt(dueEurCents);
      } else {
        dueStot = toStotinki(dueMajor, dueMinor);
      }

      const changeSt = paidStot - dueStot;
      const changeEurCents = levaStToEuroCents(changeSt);

      return { paidStot, dueStot, changeSt, changeEurCents };
    }

    function setMode(mode){
      dueMode = mode;
      const eur = mode === 'EUR';
      tabEur.classList.toggle('active', eur);
      tabBgn.classList.toggle('active', !eur);
      tabEur.setAttribute('aria-selected', eur ? 'true':'false');
      tabBgn.setAttribute('aria-selected', !eur ? 'true':'false');

      dueLabel.textContent = eur ? 'Дължима сума (EUR)' : 'Дължима сума (BGN)';
      dueMajorUnit.textContent = eur ? '€' : 'лв';
      dueMinorUnit.textContent = eur ? 'ц' : 'ст';
    }

    tabEur.addEventListener('click', ()=>setMode('EUR'));
    tabBgn.addEventListener('click', ()=>setMode('BGN'));

    document.getElementById('calcBtn').addEventListener('click', ()=>{
      const dMajor = numOrZero(dueMajor.value);
      const dMinor = clampMinor(numOrZero(dueMinor.value));
      const pLev   = numOrZero(paidLev.value);
      const pSt    = clampMinor(numOrZero(paidSt.value));

      const { dueStot, changeSt, changeEurCents } = computeChange({
        dueMode,
        dueMajor: dMajor,
        dueMinor: dMinor,
        paidLev: pLev,
        paidSt: pSt,
      });

      if(dueStot === 0){
        resultMain.textContent = '—';
        resultSub.innerHTML = '<span class="warn">Моля, въведи дължимата сума.</span>';
        return;
      }

      if(changeSt < 0){
        resultMain.textContent = `Недостиг: ${fmtEURfromCents(Math.abs(changeEurCents))} (${fmtBGNfromSt(Math.abs(changeSt))})`;
        resultSub.innerHTML = '<span class="warn">Дадените пари не стигат.</span>';
        return;
      }

      resultMain.textContent = `${fmtEURfromCents(changeEurCents)} (${fmtBGNfromSt(changeSt)})`;
      resultSub.innerHTML = '<span class="ok">Ресто за връщане.</span>';
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      dueMajor.value = '';
      dueMinor.value = '';
      paidLev.value = '';
      paidSt.value = '';
      resultMain.textContent = '—';
      resultSub.textContent = 'Въведи сума и натисни „Сметни“.';
    });

    // init
    setMode('EUR');

    function bindMinorSanitizer(el){
      el.addEventListener('input', ()=>{
        const v = el.value.replace(/[^0-9]/g,'');
        if(v.length > 2) el.value = v.slice(-2);
      });
    }
    bindMinorSanitizer(dueMinor);
    bindMinorSanitizer(paidSt);

    // Показване на build tag
    document.getElementById('buildTag').textContent = "20251231010818";

    // --- PWA: намаляване на проблеми със „застинал кеш“ ---
    // 1) service worker със versioned cache
    // 2) опит за update при всяко зареждане
    // 3) ако SW се смени -> автоматичен reload
    if('serviceWorker' in navigator){
      window.addEventListener('load', async ()=>{
        try{
          const reg = await navigator.serviceWorker.register('./sw.js?v=20251231010818');
          // форсирай проверка за update при всяко отваряне
          if(reg && reg.update) reg.update();
        }catch(e){}
      });

      let refreshing = false;
      navigator.serviceWorker.addEventListener('controllerchange', ()=>{
        if(refreshing) return;
        refreshing = true;
        window.location.reload();
      });
    }

    // --- ТЕСТОВЕ (console.assert) ---
    (function runTests(){
      const t1 = computeChange({ dueMode:'EUR', dueMajor:1, dueMinor:0, paidLev:2, paidSt:0 });
      console.assert(t1.dueStot === 196, 'T1: dueStot трябва да е 196');
      console.assert(t1.changeSt === 4, 'T1: changeSt трябва да е 4');
      console.assert(t1.changeEurCents === 2, 'T1: changeEurCents трябва да е 2');

      const t2 = computeChange({ dueMode:'BGN', dueMajor:1, dueMinor:0, paidLev:1, paidSt:0 });
      console.assert(t2.changeSt === 0, 'T2: changeSt трябва да е 0');
      console.assert(t2.changeEurCents === 0, 'T2: changeEurCents трябва да е 0');

      const t3 = computeChange({ dueMode:'EUR', dueMajor:0, dueMinor:1, paidLev:0, paidSt:2 });
      console.assert(t3.dueStot === 2, 'T3: dueStot трябва да е 2');
      console.assert(t3.changeSt === 0, 'T3: changeSt трябва да е 0');

      const t4 = computeChange({ dueMode:'BGN', dueMajor:0, dueMinor:99, paidLev:1, paidSt:0 });
      console.assert(t4.changeSt === 1, 'T4: changeSt трябва да е 1');
      console.assert(t4.changeEurCents === 1, 'T4: changeEurCents трябва да е 1');

      console.log('Тестове: OK (ако няма assert errors).');
    })();
  </script>
</body>
</html>

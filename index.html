<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ресто</title>

<meta name="theme-color" content="#2563eb">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Ресто">

<link rel="manifest" href="manifest.webmanifest?v=20251231104310">
<link rel="icon" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
:root{
  --bg:#f6f7fb;
  --card:#fff;
  --text:#111827;
  --muted:#374151;
  --border:#e5e7eb;
  --blue:#2563eb;
  --danger:#b91c1c;
  --green:#16a34a;
  --yellow:#fde68a;
  --ok:#065f46;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
  background:var(--bg);
  color:var(--text);
}
.wrap{max-width:520px;margin:0 auto;padding:14px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:14px;
}
h1{font-size:18px;margin:0 0 10px}

/* Toggle */
.seg{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  padding:6px;
  border:1px solid var(--border);
  border-radius:14px;
  background:#f3f4f6;
  margin: 8px 0 12px;
}
.seg button{
  border:1px solid var(--border);
  background:#fff;
  color:#111;
  border-radius:12px;
  padding:10px 0;
  font-size:16px;
  font-weight:800;
  line-height:1;
  display:flex;
  align-items:center;
  justify-content:center;
}
.seg button.active-eur{
  background:var(--blue);
  border-color:var(--blue);
  color:#fff;
}
.seg button:active{transform:scale(.99)}

/* Sections / fields */
.section{
  border:1px solid var(--border);
  border-radius:14px;
  padding:12px;
  background:#fff;
  margin-bottom:10px;
}
.section.error{
  border-color:var(--danger);
  background:#fff5f5;
}
.label{
  font-size:15px;
  font-weight:700;
  color:var(--muted);
  margin:0 0 8px;
}
.row{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:nowrap;
}
.field{
  flex:1;
  display:flex;
  align-items:center;
  gap:8px;
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px 10px;
  min-width:0;
  background:#fff;
}
.field input{
  width:100%;
  min-width:0;
  border:0;
  outline:none;
  font-size:20px;
  font-weight:800;
  background:transparent;
}
.unit{
  font-size:14px;
  font-weight:800;
  color:var(--muted);
  white-space:nowrap;
}

/* Buttons */
.actions{display:flex;gap:10px;margin-top:12px}
.btn{
  flex:1;
  border:none;
  border-radius:14px;
  padding:12px 12px;
  font-size:18px;
  font-weight:900;
  line-height:1;
  display:flex;
  align-items:center;
  justify-content:center;
  letter-spacing:.4px;
}
.btn.primary{background:var(--green); color:#fff;}
.btn.secondary{background:var(--yellow); color:#000;}
.btn:active{transform:scale(.99)}

/* Result */
.result{
  margin-top:12px;
  padding:12px;
  border-radius:14px;
  border:1px solid var(--border);
  background:#f9fafb;
}
.big{font-size:22px;font-weight:900}
.sub{
  font-size:13px;             /* леко намалено */
  color:var(--muted);
  margin-top:6px;
  white-space:nowrap;          /* ВИНАГИ на 1 ред */
  overflow:hidden;
  text-overflow:ellipsis;      /* ако екранът е супер тесен */
}
.warn{color:var(--danger);font-weight:800}
.ok{color:var(--ok);font-weight:800}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Калкулатор за ресто</h1>

    <div class="seg" role="tablist" aria-label="Дължима сума">
      <button id="tabEur" class="active-eur" type="button" role="tab" aria-selected="true">EUR</button>
      <button id="tabBgn" type="button" role="tab" aria-selected="false">BGN</button>
    </div>

    <div class="section" id="dueSection">
      <div class="label" id="dueLabel">Дължима сума (EUR)</div>
      <div class="row">
        <div class="field">
          <input id="dueMajor" inputmode="numeric" pattern="[0-9]*" placeholder="0" aria-label="Дължима сума - основна" />
          <span class="unit" id="dueMajorUnit">€</span>
        </div>
        <div class="field">
          <input id="dueMinor" inputmode="numeric" pattern="[0-9]*" placeholder="00" aria-label="Дължима сума - стотинки/центове" />
          <span class="unit" id="dueMinorUnit">ц</span>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="label">Дадени пари (BGN)</div>
      <div class="row">
        <div class="field">
          <input id="paidLev" inputmode="numeric" pattern="[0-9]*" placeholder="0" aria-label="Дадени лева" />
          <span class="unit">лв</span>
        </div>
        <div class="field">
          <input id="paidSt" inputmode="numeric" pattern="[0-9]*" placeholder="00" aria-label="Дадени стотинки" />
          <span class="unit">ст</span>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn primary" id="calcBtn" type="button">СМЕТНИ</button>
      <button class="btn secondary" id="clearBtn" type="button">ИЗЧИСТИ</button>
    </div>

    <div class="result" aria-live="polite">
      <div class="big" id="resultMain">—</div>
      <div class="sub" id="resultSub">Въведи сума и натисни „Сметни“.</div>
    </div>
  </div>
</div>

<script>
const RATE = 1.95583;

const tabEur = document.getElementById('tabEur');
const tabBgn = document.getElementById('tabBgn');

const dueSection = document.getElementById('dueSection');
const dueLabel = document.getElementById('dueLabel');
const dueMajorUnit = document.getElementById('dueMajorUnit');
const dueMinorUnit = document.getElementById('dueMinorUnit');

const dueMajor = document.getElementById('dueMajor');
const dueMinor = document.getElementById('dueMinor');
const paidLev  = document.getElementById('paidLev');
const paidSt   = document.getElementById('paidSt');

const resultMain = document.getElementById('resultMain');
const resultSub  = document.getElementById('resultSub');

let dueMode = 'EUR';

function numOrZero(v){
  v = (v ?? '').toString().trim();
  if(v === '') return 0;
  const cleaned = v.replace(/[^0-9]/g,'');
  return cleaned === '' ? 0 : parseInt(cleaned, 10);
}
function normalizeMinor(el){
  let v = (el.value || '').replace(/\D/g,'');
  if(v === '') { el.value = ''; return; }
  if(v.length === 1) v = '0' + v;
  if(v.length > 2) v = v.slice(-2);
  el.value = v;
}
[dueMinor, paidSt].forEach(el=>{
  el.addEventListener('input', ()=>{
    let v = el.value.replace(/\D/g,'');
    if(v.length > 2) v = v.slice(-2);
    el.value = v;
  });
  el.addEventListener('blur', ()=>normalizeMinor(el));
});

function setMode(mode){
  dueMode = mode;
  const eur = mode === 'EUR';

  tabEur.classList.toggle('active-eur', eur);
  tabBgn.classList.toggle('active-eur', !eur);
  tabEur.setAttribute('aria-selected', eur ? 'true' : 'false');
  tabBgn.setAttribute('aria-selected', !eur ? 'true' : 'false');

  dueLabel.textContent = eur ? 'Дължима сума (EUR)' : 'Дължима сума (BGN)';
  dueMajorUnit.textContent = eur ? '€' : 'лв';
  dueMinorUnit.textContent = eur ? 'ц' : 'ст';
}
tabEur.addEventListener('click', ()=>setMode('EUR'));
tabBgn.addEventListener('click', ()=>setMode('BGN'));

function fmtEUR(cents){
  const sign = cents < 0 ? '-' : '';
  cents = Math.abs(cents);
  return sign + (cents/100).toFixed(2).replace('.', ',') + ' €';
}
function fmtBGN(st){
  const sign = st < 0 ? '-' : '';
  st = Math.abs(st);
  return sign + (st/100).toFixed(2).replace('.', ',') + ' лв';
}

/* --- Web Audio --- */
let audioCtx = null;
function ensureAudio(){
  if(!audioCtx){
    const AC = window.AudioContext || window.webkitAudioContext;
    if(AC) audioCtx = new AC();
  }
  if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume().catch(()=>{});
  return audioCtx;
}

// Cash register-ish: bell ding + quick clack
function playCashRegister(){
  const ctx = ensureAudio();
  if(!ctx) return;
  const now = ctx.currentTime;

  const master = ctx.createGain();
  master.gain.setValueAtTime(0.8, now);
  master.connect(ctx.destination);

  const bell = (f, t0) => {
    const o = ctx.createOscillator();
    o.type = 'sine';
    o.frequency.setValueAtTime(f, t0);
    const g = ctx.createGain();
    g.gain.setValueAtTime(0.0001, t0);
    g.gain.exponentialRampToValueAtTime(0.35, t0 + 0.006);
    g.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.35);
    o.connect(g); g.connect(master);
    o.start(t0); o.stop(t0 + 0.4);
  };
  bell(1760, now);
  bell(2200, now + 0.002);

  const buf = ctx.createBuffer(1, Math.floor(ctx.sampleRate * 0.08), ctx.sampleRate);
  const d = buf.getChannelData(0);
  for(let i=0;i<d.length;i++){
    d[i] = (Math.random()*2-1) * Math.exp(-i/(d.length/6));
  }
  const src = ctx.createBufferSource(); src.buffer = buf;

  const bp = ctx.createBiquadFilter();
  bp.type = 'bandpass';
  bp.frequency.value = 900;
  bp.Q.value = 0.8;

  const ng = ctx.createGain();
  ng.gain.setValueAtTime(0.0001, now+0.05);
  ng.gain.exponentialRampToValueAtTime(0.55, now+0.055);
  ng.gain.exponentialRampToValueAtTime(0.0001, now+0.13);

  src.connect(bp); bp.connect(ng); ng.connect(master);
  src.start(now+0.05); src.stop(now+0.13);
}

// Wind whoosh: filtered noise sweep
function playWind(){
  const ctx = ensureAudio();
  if(!ctx) return;
  const now = ctx.currentTime;

  const master = ctx.createGain();
  master.gain.setValueAtTime(0.0001, now);
  master.gain.exponentialRampToValueAtTime(0.45, now + 0.02);
  master.gain.exponentialRampToValueAtTime(0.0001, now + 0.18);
  master.connect(ctx.destination);

  const buf = ctx.createBuffer(1, Math.floor(ctx.sampleRate * 0.22), ctx.sampleRate);
  const d = buf.getChannelData(0);
  for(let i=0;i<d.length;i++){
    d[i] = (Math.random()*2-1) * 0.6;
  }
  const src = ctx.createBufferSource(); src.buffer = buf;

  const lp = ctx.createBiquadFilter();
  lp.type = 'lowpass';
  lp.frequency.setValueAtTime(1400, now);
  lp.frequency.exponentialRampToValueAtTime(320, now + 0.12);

  const hp = ctx.createBiquadFilter();
  hp.type = 'highpass';
  hp.frequency.setValueAtTime(120, now);

  src.connect(lp); lp.connect(hp); hp.connect(master);
  src.start(now); src.stop(now + 0.22);
}

document.getElementById('calcBtn').addEventListener('click', ()=>{
  playCashRegister();

  dueSection.classList.remove('error');

  const dMajorRaw = dueMajor.value;
  const dMinorRaw = dueMinor.value;
  if((dMajorRaw ?? '').trim() === '' && (dMinorRaw ?? '').trim() === ''){
    dueSection.classList.add('error');
    resultMain.textContent = '—';
    resultSub.innerHTML = '<span class="warn">Моля, въведи дължимата сума.</span>';
    dueMajor.focus();
    return;
  }

  normalizeMinor(dueMinor);
  normalizeMinor(paidSt);

  const dMajor = numOrZero(dueMajor.value);
  const dMinor = numOrZero(dueMinor.value);
  const pLev   = numOrZero(paidLev.value);
  const pSt    = numOrZero(paidSt.value);

  const paidStot = pLev*100 + (pSt % 100);

  let dueStot;
  if(dueMode === 'EUR'){
    const dueEurCents = dMajor*100 + (dMinor % 100);
    dueStot = Math.round((dueEurCents/100) * RATE * 100);
  } else {
    dueStot = dMajor*100 + (dMinor % 100);
  }

  const changeSt = paidStot - dueStot;
  const changeEurCents = Math.round((changeSt/100) / RATE * 100);

  if(changeSt < 0){
    const shortageSt = -changeSt;
    const shortageEur = -changeEurCents;
    resultMain.textContent = 'Недостиг: ' + fmtEUR(shortageEur) + ' (' + fmtBGN(shortageSt) + ')';
    resultSub.innerHTML = '<span class="warn">Дадените пари не стигат.</span>';
    return;
  }

  resultMain.textContent = fmtEUR(changeEurCents) + ' (' + fmtBGN(changeSt) + ')';
  resultSub.innerHTML = '<span class="ok">Ресто за връщане.</span>';
});

document.getElementById('clearBtn').addEventListener('click', ()=>{
  playWind();

  [dueMajor,dueMinor,paidLev,paidSt].forEach(i=>i.value='');
  dueSection.classList.remove('error');
  resultMain.textContent = '—';
  resultSub.textContent = 'Въведи сума и натисни „Сметни“.';
  dueMajor.focus();
});

window.addEventListener('load', ()=>dueMajor.focus());
setMode('EUR');

if('serviceWorker' in navigator){
  navigator.serviceWorker.register('./sw.js?v=20251231104310');
}
</script>
</body>
</html>
